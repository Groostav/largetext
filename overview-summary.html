<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (version 1.7.0_55) on Sat Apr 26 23:14:28 CEST 2014 -->
<title>Overview (largetext 0.1.0 API)</title>
<meta name="date" content="2014-04-26">
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="Overview (largetext 0.1.0 API)";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li class="navBarCell1Rev">Overview</li>
<li>Package</li>
<li>Class</li>
<li><a href="overview-tree.html">Tree</a></li>
<li><a href="deprecated-list.html">Deprecated</a></li>
<li><a href="index-all.html">Index</a></li>
<li><a href="help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li>Prev</li>
<li>Next</li>
</ul>
<ul class="navList">
<li><a href="index.html?overview-summary.html" target="_top">Frames</a></li>
<li><a href="overview-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 class="title">largetext 0.1.0 API</h1>
</div>
<div class="header">
<div class="subTitle">
<div class="block">largetext: use large text files as CharSequences</div>
</div>
<p>See: <a href="#overview_description">Description</a></p>
</div>
<div class="contentContainer">
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Packages table, listing packages, and an explanation">
<caption><span>Packages</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Package</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="com/github/fge/largetext/package-summary.html">com.github.fge.largetext</a></td>
<td class="colLast">
<div class="block">Main user interface</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="com/github/fge/largetext/load/package-summary.html">com.github.fge.largetext.load</a></td>
<td class="colLast">
<div class="block">Classes dealing with file I/O</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="com/github/fge/largetext/range/package-summary.html">com.github.fge.largetext.range</a></td>
<td class="colLast">
<div class="block">Limited-purpose range classes</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="com/github/fge/largetext/sequence/package-summary.html">com.github.fge.largetext.sequence</a></td>
<td class="colLast">
<div class="block">Subsequences of a <a href="com/github/fge/largetext/LargeText.html" title="class in com.github.fge.largetext"><code>LargeText</code></a></div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="footer"><a name="overview_description">
<!--   -->
</a>
<div class="subTitle">
<div class="block"><h1>largetext: use large text files as CharSequences</h1>

<h1>Why</h1>

<p>This project started life as a proof of concept; it stemmed from a <a
href="http://stackoverflow.com/q/22017480/1093528" target="_blank">discussion
on StackOverflow</a>, where the user wanted to search for a pattern (using a
<a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html?is-external=true" title="class or interface in java.util.regex"><code>Matcher</code></a> on a large text file.</p>

<p>The suggested and accepted answer (mine) was to implement <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/CharSequence.html?is-external=true" title="class or interface in java.lang"><code>CharSequence</code></a> over such a large text file, since a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html?is-external=true" title="class or interface in java.util.regex"><code>Matcher</code></a> expects a <code>CharSequence</code> as an argument.
This interface is implemented, among other things, by <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang"><code>String</code></a>
and <a href="http://docs.oracle.com/javase/7/docs/api/java/nio/CharBuffer.html?is-external=true" title="class or interface in java.nio"><code>CharBuffer</code></a>.</p>

<p>And now, <a href="com/github/fge/largetext/LargeText.html" title="class in com.github.fge.largetext"><code>LargeText</code></a> as well.</p>

<p>Note that this can not only be used with regexes: you can also use this
project with <a href="https://github.com/parboiled1/grappa">Grappa</a>. Yes, you
can use arbitrary grammars entirely in Java on large text files!</p>

<h1>The challenge(s)</h1>

<p>Implementing this did not go without a number of problems to solve; and most
of these problems come from the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/CharSequence.html?is-external=true" title="class or interface in java.lang"><code>CharSequence</code></a> interface
itself. And to start with:</p>

<h2>Querying operations might sleep</h2>

<p>And <code>CharSequence</code> does not account for this; in fact, it pretty
much assumes that all the characters you deal with are readily accessible, which
is not the case here.</p>

<p>As a consequence, you cannot throw <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/InterruptedException.html?is-external=true" title="class or interface in java.lang"><code>InterruptedException</code></a>...
It is therefore the responsibility of the implementation to deal correctly with
that. Here, it is dealt with by terminating the relevant threads and throwing an
unchecked exception: <a href="com/github/fge/largetext/LargeTextException.html" title="class in com.github.fge.largetext"><code>LargeTextException</code></a>.</p>

<h2>Accesses may be concurrent, and anywhere in the sequence</h2>

<p>While this is not strictly required by the interface, in practice this is the
case: you can access any part of a <code>String</code> or
<code>CharBuffer</code>, or query its length, in any number of threads,
concurrently. <code>LargeText</code> must offer the same guarantees for it to
pretend being a <code>CharSequence</code> at all.</p>

<p>Also, accesses can be completely random. One thread can ask to read from
the beginning of the sequence, the other at the middle, the other at the end.
<code>LargeText</code> must be able to deal with that as well.</p>

<p>And of course, there is the not so trivial problem of <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/CharSequence.html?is-external=true#subSequence(int, int)" title="class or interface in java.lang"><code>.subSequence()</code></a>.</p>

<h2>Memory usage should be controlled -- and controllable</h2>

<p>Dealing with large files of course has impacts on memory; if you use, say, a
    2 GiB file, you don't want the whole of it to eat valuable heap space.</p>

<p>The file must therefore be processed in chunks -- <em>without</em> altering
    the "streamlineness" of <code>CharSequence</code> which has no such notions.</p>

<h2>A decoding process is needed</h2>

<p>And this problem is pretty much unique to largetext. Its source is not a
character source but a <em>byte</em> source; what is more, said source can fail:
I/O errors, unmappable byte sequence etc.</p>

<p>Adding to that the fact that errors can happen at any moment. Fun!</p>

<p>And about that byte vs char problem...</p>

<h2>Character codings are often not fixed in length</h2>

<p>Starting with the now universally (?) used UTF-8 character coding: a single
Unicode character can be encoded using anywhere from one byte to four bytes.</p>

<p>Which means you can experience "short reads" (an incomplete sequence) when
decoding a given byte array within the source file. This also needs to be
dealt with.</p>

<p>And finally there is that:</p>

<h2><code>.toString()!</code></h2>

<p>Yes, the most trivial and normally innocuous operation on any Java object is
a death trap with this package! The <a
href="http://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#toString--"
target="_blank">javadoc</a> of <code>CharSequence</code> says:</p>

<blockquote>
    Returns a string containing the characters in this sequence in the same
    order as this sequence. <strong>The length of the string will be the length
    of this sequence.</strong>
</blockquote>

<p>This means a string as large as a file which is potentially <em>several
gigabytes in size</em>!</p>

<p>There should therefore be an option to break this contract... You certainly
don't want to be greeted with an <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/OutOfMemoryError.html?is-external=true" title="class or interface in java.lang"><code>OutOfMemoryError</code></a> just because
you inadvertently used a <code>LargeText</code> instance in a string
concatenation!</p>

<h2>And, uh, is that all?</h2>

<p>At least, that is the list of all the problems I could see. And largetext
has a solution for each of them!</p>

<h1>Using it</h1>

<p>This is a bare bones, standard use of this API:</p>

<pre>
    // Default factory: UTF-8 character encoding, 2 MiB window size
    final LargeTextFactory factory = LargeTextFactory.defaultFactory();
    final Path fileToSearch = Paths.get("path/to/large/textfile.txt");
    final Pattern pattern = Pattern.compile(...);

    try (
        final LargeText input = factory.fromPath(fileToSearch);
    ) {
        final Matcher m = pattern.matcher(input);
        if (m.find())
            System.out.println(fileToSearch + " has a match");
    }
</pre>

<p>The process is simple: create (and, if needed, configure) a <a href="com/github/fge/largetext/LargeTextFactory.html" title="class in com.github.fge.largetext"><code>LargeTextFactory</code></a>, grab a <a href="http://docs.oracle.com/javase/7/docs/api/java/nio/file/Path.html?is-external=true" title="class or interface in java.nio.file"><code>Path</code></a>
to the file we want to use, create a <a href="com/github/fge/largetext/LargeText.html" title="class in com.github.fge.largetext"><code>LargeText</code></a>
instance using this factory and path, and use it.</p>

<p>You will note the use of a try-with-resources statement.
<code>LargeText</code> implements <a href="http://docs.oracle.com/javase/7/docs/api/java/io/Closeable.html?is-external=true" title="class or interface in java.io"><code>Closeable</code></a> in addition to
<code>CharSequence</code> and in order to not leak any resources (starting with
the file descriptor), you must, at the very least, <a href="http://docs.oracle.com/javase/7/docs/api/java/io/Closeable.html?is-external=true#close()" title="class or interface in java.io"><code>.close()</code></a> it!</p>

<p>The comment on the first line hints that the factory is configurable. Here is
an example of it:</p>

<pre>
    // Create a factory with ISO-8859-15 encoding and a 12 MiB window size
    final LargeTextFactory factory = LargeTextFactory.newBuilder()
        .setCharsetByName("ISO-8859-15")
        .setWindowSize(12, SizeUnit.MiB)
        .build();
</pre>

<p>The <a href="com/github/fge/largetext/LargeTextFactory.Builder.html#setCharsetByName(java.lang.String)"><code>LargeTextFactory.Builder.setCharsetByName(java.lang.String)</code></a> method tells
which character coding should be used when decoding the file contents, and the
<a href="com/github/fge/largetext/LargeTextFactory.Builder.html#setWindowSize(int, com.github.fge.largetext.SizeUnit)"><code>LargeTextFactory.Builder.setWindowSize(int, com.github.fge.largetext.SizeUnit)</code></a> method
tells how large a chunk of bytes the decoding process should use from the file.
</p>

<p><strong>TODO: .toString() threshold!</strong></p>

<h1>Short overview of the internals...</h1>

<h2>The decoding process</h2>

<p>The decoding process is done with the <a href="com/github/fge/largetext/load/TextDecoder.html" title="class in com.github.fge.largetext.load"><code>TextDecoder</code></a> class; one instance of this class is
created for each <code>LargeText</code> instance.</p>

<p>This class will create a background thread which is the real workhorse; it
will not only (attempt to) decode the whole contents of the file, but
it will also signal waiters (see below) to tell them that the number of
characters they wanted is now available.</p>

<h2>Caching character contents</h2>

<p>The decoding process, by itself, will not cache anything, it is just here to
ensure that at least this number of characters can be read from the file. The
role of actually providing these characters is delegated to a <a href="com/github/fge/largetext/load/TextCache.html" title="class in com.github.fge.largetext.load"><code>TextCache</code></a>. The "unit" of a cached entry is a
<a href="com/github/fge/largetext/load/TextRange.html" title="class in com.github.fge.largetext.load"><code>TextRange</code></a>, which maps a byte window of the
input file to a character window.</p>

<p>This cache loads character "windows" on demand, and has an expiry policy of
30 seconds after last access; if no thread requires the same buffer within this
delay, it is discarded from the cache.</p>

<h2>Dealing with potentially waiting operations...</h2>

<p>All operations from <code>CharSequence</code> can potentially wait for the
required number of characters to be available; all of them for
<code>.length()</code>, or part of them for <code>.charAt()</code> and
<code>.subSequence()</code>.</p>

<p>Callers of <code>.length()</code> will all share a same <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CountDownLatch.html?is-external=true" title="class or interface in java.util.concurrent"><code>CountDownLatch</code></a> on which they will wait for the decoding
process to wake them up.</p>

<p>For the two other operations, a <a href="com/github/fge/largetext/load/CharWaiter.html" title="class in com.github.fge.largetext.load"><code>CharWaiter</code></a> instance will be created; it will
be queued <em>if and only if</em> the requested number of characters is not
available at the time of the call. It will then be woken up when the number of
requested character are available, or "greeted" with an exception if it is not
(either because the requested index is out of range, or because the decoding
process failed).</p>

<h2>And there is more...</h2>

<p>All the nooks and crannies can not be explained in this single page; if you
want to know more, you are encouraged to read the javadoc of all packages and
classes!</p>

<p>Have fun!</p></div>
</div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li class="navBarCell1Rev">Overview</li>
<li>Package</li>
<li>Class</li>
<li><a href="overview-tree.html">Tree</a></li>
<li><a href="deprecated-list.html">Deprecated</a></li>
<li><a href="index-all.html">Index</a></li>
<li><a href="help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li>Prev</li>
<li>Next</li>
</ul>
<ul class="navList">
<li><a href="index.html?overview-summary.html" target="_top">Frames</a></li>
<li><a href="overview-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
